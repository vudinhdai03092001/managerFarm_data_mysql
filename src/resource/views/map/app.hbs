{{> header}}
{{>navbar}}
{{#if onedata}}

<main id="main" class="main">
    <div class="pagetitle">
        <h1 style="text-align: center;">Khu vực vùng trồng</h1>
    </div><!-- End Page Title -->
    <section class="section dashboard">
        <div class="row">
            <div class="col-lg-3">
                <a href="/map/setview"><button class="btn btn-success">Chọn khu vực khác </button></a><br><br>
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Cơ cấu cây trồng</h5>
                        {{#each onedata}}
                        <div id="setview" data-lat="{{this.lat}}" data-lng="{{this.lng}}"
                            data-zoomLevel="{{this.zoomLevel}}"></div>
                        {{/each}}
                        <form method="POST" class="form row" id="form-1">
                            <div class="form-group  mt-3 ">
                                <label for="name" class="form-label">Tên vùng trồng :</label>
                                <input type="text" class="form-control" id="namearea" placeholder="vùng trồng ..."
                                    name="namearea">
                                <div id="message"></div>
                            </div>
                        </form>
                        <div class="box-center mt-4">
                            <button class="btn btn-primary w-50 " id="btnsave" type="submit">Lưu</button>
                        </div>
                        <br><br>
                        <p>Danh sách vùng trồng</p>
                        <ol class="list-group list-group-numbered">
                            {{#each data}}
                            <li class="list-group-item"><a href="" style="color: black;">{{this.namearea}}</a></li>
                            {{/each}}
                        </ol>
                    </div>
                    <br>
                </div>
            </div><!-- End Recent Activity -->
            <div class="col-lg-9">
                <div class="row ">
                    <!-- Reports -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div id="map" style="width: 100%; height: 70vh;"></div> <!-- End Line Chart -->
                            </div>
                        </div>
                    </div><!-- End Reports -->
                </div>
            </div><!-- End Left side columns -->
        </div>
    </section>
</main><!-- End #main -->
{{/if}}
{{#unless onedata}}
<main id="main" class="main">
    <div class="pagetitle">
        <h1 style="text-align: center;">Khoanh vùng khu vực trồng của bạn </h1>
        <button style="width: 20%; " class="btn btn-success" id="clickbtn">Chọn khu vực </button>
    </div><!-- End Page Title -->
    <section class="section dashboard">
        <div class="row">
            <div class="col-lg-12">
                <div class="row ">
                    <!-- Reports -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div id="setmap" style="width: 100%; height: 70vh;"></div> <!-- End Line Chart -->
                            </div>
                        </div>
                    </div><!-- End Reports -->
                </div>
            </div><!-- End Left side columns -->
        </div>
    </section>
</main><!-- End #main -->
{{/unless}}
{{> footer}}
<script src="/js/validate.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="/js/setview.js"></script>
<script>
    btnsave = document.getElementById('btnsave')
    message = document.getElementById('message')

    //lấy tọa độ khi set view
    var setview = document.getElementById('setview')
    var lat = setview.getAttribute('data-lat')
    var lng = setview.getAttribute('data-lng')
    var zoomLevel = setview.getAttribute('data-zoomLevel')

    document.addEventListener('DOMContentLoaded', function () {
        var map = L.map('map').setView([lat, lng], zoomLevel);
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        //Layer controller
        var baseMaps = {
            "OSM": osm,
            "Google map": googleStreets,
        }

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            draw: {
                circlemarker: false,
                marker: true,
                // polyline: false,
                // polygon: false,
                rectangle: false
            },
            edit: {
                featureGroup: drawnItems,
            },
        });
        map.addControl(drawControl);

        map.on('draw:created', function (event) {
            var type = event.layerType;
            var layer = event.layer;
            if (layer instanceof L.Marker) {
                // Lấy tọa độ của điểm khi nó được vẽ
                var latlng = layer.getLatLng();
                // Xử lý tọa độ theo ý muốn của bạn
                console.log('Tọa độ của điểm:', latlng);
            }
            else if (type === 'polygon') {
                // Xử lý khi vẽ vùng
                polygon = layer.toGeoJSON();
            }
            drawnItems.addLayer(layer);
            //lấy tọa độ khi vẽ poligon
            var localpolygon = polygon.geometry.coordinates[0];

            //chuyển tọa độ từ object sang string
            var parseLocalpolygon = JSON.stringify(localpolygon)
            btnsave.onclick = function () {
                input = document.getElementById('namearea').value
                if (input === '') {
                    message.innerHTML = "vui lòng nhập vùng trồng !"
                }
                else {
                    $.ajax({
                        url: '/map/store',
                        type: 'POST',
                        data: {
                            namearea: input,
                            coordinates: parseLocalpolygon
                        }
                    })
                    //bắt dự kiên load trang
                    location.reload();
                }
            }
        });


        // if (navigator.geolocation) {
        //      navigator.geolocation.getCurrentPosition(getPosition)
        //  } else {
        //       console.log("Your browser doesn't support geolocation feature!")
        //   }
        //  var marker, circle;

        //   function getPosition(position) {
        ///      var lat = position.coords.latitude
        //      var long = position.coords.longitude
        //      var accuracy = position.coords.accuracy
        //     marker = L.marker([lat, long]).addTo(map)
        //      console.log(lat, long, accuracy)
        //  }

        //Add scale
        //  var scale = L.control.scale({ position: 'bottomright' }).addTo(map);

        //hàm load dữ liệu 
        function loadData() {
            $.ajax({
                url: '/map/loadMap',
                type: 'GET',
            }).then(data => {
                var list = data.data.map((toado) => {
                    //chuyển dữ liệu về dạng object
                    var par = JSON.parse(toado.coordinates)
                    arr = []
                    arr.push(par)
                    return {
                        type: "Feature",
                        properties: { "name": "Sample GeoJSON Feature" },
                        geometry: {
                            type: "Polygon",
                            coordinates: arr,
                            type: "LineString"
                        },
                    }
                }
                )
                //hiển thị dữ liệu ra client
                var stateData = {
                    "type": "FeatureCollection",
                    "features": list
                }
                //Caculate measure
                L.geoJSON(stateData, {
                    onEachFeature: function (feature, layer) {
                        // Bind Popup với nội dung từ thuộc tính "name" của đối tượng GeoJSON
                        console.log(feature.properties.name)
                        layer.bindPopup('<b>' + feature.properties.name + '</b>');
                    }
                }).addTo(map);

            }).catch(err => console.log(err))
        }
        loadData()
        // get data từ localstorage sau đó gán stateData
    });

</script>